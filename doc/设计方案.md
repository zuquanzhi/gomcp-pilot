1. 版本轨迹
- v0.4：转向个人本地守护进程；移除多租户/分布式，增加子进程管理、TUI 拦截、人工确认。
- v0.3：团队版网关设计（废弃）。

---
2. 产品定义
gomcp-pilot 是运行在本地的轻量级 MCP 守护进程，位于 LLM 客户端（Claude Desktop 等）与本地/容器化 MCP Server 之间。
- The Guard：高危操作必须人审（写文件、执行命令）。
- The Hub：单个 config.yaml 聚合全部工具，所有客户端复用。
- The Inspector：TUI 实时展示请求/响应，支持事后审计。

---
3. 目标与边界
- 单二进制、无 Docker 强依赖，config.yaml 即开箱。
- HITL（Human-in-the-loop）：默认拦截写/执行，用户按键确认后放行。
- Pilot 负责启动/回收下游 MCP Stdio 进程。
- 观测友好：终端可见实时流，SQLite 记录可回溯。

---
4. 架构与流程
gomcp-pilot 一侧暴露 HTTP/SSE 给客户端，另一侧通过 stdio 维护 MCP 子进程。
- 启动：读取配置，拉起 upstream 进程。
- 发现：聚合工具列表并暴露给客户端。
- 调用：请求进入 -> 策略判定 -> 触发 TUI 确认（必要时）-> 转发执行 -> 记录结果。
- 退出：主进程退出时清理所有子进程。

---
5. 核心功能
- 配置与进程管理：`~/.config/gomcp/config.yaml` 定义端口、鉴权、upstream 列表；启动/重启/销毁子进程。
```yaml
port: 8080
auth_token: "auto-generated" # 或指定
upstreams:
  - name: "project-files"
    command: "npx"
    args: ["-y", "@modelcontextprotocol/server-filesystem", "/Users/me/Code"]
    auto_approve: false
  - name: "web-search"
    command: "docker"
    args: ["run", "mcp/brave-search"]
    auto_approve: true
```
- 交互式拦截器：Safe（读）直接放行；Risky（写/执行）在 TUI 阻塞，60 秒未确认则拒绝。
- 本地鉴权：启动时生成或读取 `GOMCP_KEY`；客户端需携带 `Authorization: Bearer <token>`，仅用于防 CSRF。
- 审计与界面：Bubbletea TUI 展示流与详情；SQLite（`~/.gomcp/audit.db`）持久化调用历史。

---
6. 技术实现概览
- 语言/框架：Go + cobra + bubbletea/lipgloss。
- 协议：modelcontextprotocol/go-sdk 暴露 SSE；轻量 Stdio client 连接子进程。
- 模块：`cmd/gomcp`（入口）；`internal/config`（配置）；`process`（进程生命周期）；`server`（SSE/HTTP）；`interceptor`（策略与提示）；`tui`；`store`（审计）。

---
7. 验收标准
- 配置后直接启动，无额外依赖。
- 客户端可发现所有工具并调用成功。
- Risky 操作必须被拦截并可拒绝；拒绝时客户端收到明确错误。
- 退出时子进程无残留；历史可在 TUI/SQLite 查看。
